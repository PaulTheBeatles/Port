<!DOCTYPE html>
<html>

<head>
    <title>Senku</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/EXRLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dat.gui@0.7.9/build/dat.gui.min.js"></script>
    <script>
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(30, 40, 30);
        const controls = new THREE.OrbitControls(camera, renderer.domElement);

        // แสง
        const ambient = new THREE.AmbientLight(0x808080, 0.3);
        scene.add(ambient);
        const sunLight = new THREE.DirectionalLight(0xffeedd, 0.5);
        sunLight.castShadow = true;
        sunLight.position.set(10, 5, 10);
        scene.add(sunLight);

        // Environment
        const envGen = new THREE.PMREMGenerator(renderer);
        envGen.compileEquirectangularShader();
        new THREE.EXRLoader().load("https://paulthebeatles.github.io/Port/sky.exr", tex => {
            const envTex = envGen.fromEquirectangular(tex).texture;
            scene.environment = envTex;
            scene.background = envTex;
            tex.dispose(); envGen.dispose();
        });

        // GUI
        // const gui = new dat.GUI({ width: 300 });
        // const lightUI = gui.addFolder("Light XYZ");
        // lightUI.add(sunLight.position, "x", -20, 20, 0.1);
        // lightUI.add(sunLight.position, "y", -20, 20, 0.1);
        // lightUI.add(sunLight.position, "z", -20, 20, 0.1);
        // lightUI.open();

        // โหลด GLTF Model
        const clickable = [];
        const loader = new THREE.GLTFLoader();
        loader.load("https://paulthebeatles.github.io/Port/Port3.glb", gltf => {
            gltf.scene.traverse(obj => {
                if (obj.isMesh) {
                    obj.castShadow = true;
                    obj.receiveShadow = true;
                }
                // สมมติวัตถุชื่อ Cat_Raycaster
                if (obj.name === "Cat_Raycaster") clickable.push(obj);
            });
            scene.add(gltf.scene);
        });

        // พื้น
        const groundTex = new THREE.TextureLoader().load("https://paulthebeatles.github.io/Senku/rocky_terrain_02_diff_1k.jpg", t => {
            t.wrapS = t.wrapT = THREE.RepeatWrapping;
        });
        const groundMat = new THREE.MeshStandardMaterial({ map: groundTex });
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(3, 3), groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Raycaster
        const raycaster = new THREE.Raycaster();
        const pointer = new THREE.Vector2();

        // พรีเซ็ตตำแหน่งกล้อง
        const VIEWS = {
            Cat_Raycaster: { pos: new THREE.Vector3(15, 10, 15), tar: new THREE.Vector3(0, 0, 0) }
        };

        function onPick(event) {
            pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
            pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(pointer, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);
            if (intersects.length > 0) {
                let clicked = intersects[0].object;
                while (clicked.parent && clicked.name !== "Cat_Raycaster") {
                    clicked = clicked.parent;
                }
                if (clicked.name === "Cat_Raycaster") {
                    const view = VIEWS[clicked.name];
                    if (view) {
                        // ย้ายกล้องแบบทันที (ถ้าอยาก smooth later ใช้ lerp)
                        camera.position.copy(view.pos);
                        controls.target.copy(view.tar);
                        controls.update();

                    }
                }
            }
        }

        renderer.domElement.addEventListener('click', onPick);

        // Loop
        (function loop() {
            renderer.render(scene, camera);
            requestAnimationFrame(loop);
        })();

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>