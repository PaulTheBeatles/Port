<!DOCTYPE html>
<html>

<head>
    <title>Home_Port</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
        }

        /* Loading Screen Style (Full Screen) */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #111111;
            /* Dark background for a night theme */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 1s;
        }

        #loadingText {
            color: #ffffff;
            font-size: 20px;
            font-weight: 600;
            margin-top: 15px;
        }

        #progressBar {
            width: 250px;
            height: 10px;
            background-color: #333;
            border-radius: 5px;
            overflow: hidden;
        }

        #progressBarInner {
            height: 100%;
            width: 0%;
            background-color: #05e117;
            transition: width 0.1s ease-out;
        }

        /* --- NEW: Small Loading Indicator Style (Top Right) --- */
        #smallLoadingIndicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #05e117;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            display: none;
            /* Hidden by default */
            z-index: 10000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        /* -------------------------------------------------------- */

        /* Panel Project */
        #projectPanel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.98);
            padding: 30px 20px 20px 20px;
            display: none;
            width: 380px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(6px);
            pointer-events: auto;
        }

        #closePanel {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: #ff5f57;
            color: white;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        #closePanel:hover {
            transform: scale(1.2);
            background: #ff3b30;
        }

        /* Cat Speech Bubble */
        #catSpeech,
        #envPopup,
        #telescopePopup {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 14px 28px;
            border-radius: 20px;
            font-weight: 600;
            font-family: 'Segoe UI', sans-serif;
            display: none;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 1000;
            pointer-events: auto;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* Cat Yes/No Choice */
        #catChoice,
        #envPopupButtons,
        #telescopeChoice {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 20px;
            border-radius: 12px;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
            pointer-events: auto;
        }

        #catChoice button,
        #envPopupButtons button,
        #telescopeChoice button {
            margin-left: 8px;
            padding: 6px 14px;
            font-weight: 600;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        #catChoice button:hover,
        #envPopupButtons button:hover,
        #telescopeChoice button:hover {
            opacity: 0.85;
        }

        #catChoice button#catYes,
        #telescopeChoice button#telescopeYes,
        #envPopupButtons button#envYes {
            background: #05e117;
            color: white;
        }

        #catChoice button#catNo,
        #telescopeChoice button#telescopeNo,
        #envPopupButtons button#envNo {
            background: #de1304;
            color: white;
        }

        /* Toggle Buttons Container */
        .toggleButtons {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
        }

        .toggleBtn {
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 12px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, background 0.2s;
        }

        .toggleBtn:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 1);
        }

        .toggleBtn span {
            margin-right: 8px;
        }

        /* Home Button */
        #homeBtn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 12px 18px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.2s, background 0.2s;
        }

        #homeBtn:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 1);
        }

        @media screen and (max-width: 480px) {
            #projectPanel {
                width: 90%;
                padding: 20px;
            }

            .toggleBtn {
                padding: 10px 16px;
                font-size: 14px;
            }

            #homeBtn {
                padding: 10px 14px;
                font-size: 14px;
            }
        }
    </style>
</head>

<body>
    <div id="loadingOverlay">
        <div id="progressBar">
            <div id="progressBarInner"></div>
        </div>
        <div id="loadingText">Loading Scene...</div>
    </div>
    <div id="smallLoadingIndicator">Loading Environment...</div>
    <button id="homeBtn">üè† Home</button>

    <div id="projectPanel">
        <button id="closePanel">‚úñ</button>
        <h2>My Academic Projects</h2>
        <ul>
            <li><strong>Java Construction Project</strong> (Oct 2024)<br>- Developed a desktop To-Do List application using Java<br>- Implemented features for adding, updating, and deleting tasks</li>
            <li><strong>Database System Project</strong> (Mar 2025)<br>- Designed ER diagrams and Normalization of Enrollment System<br>- Created SQL queries for Enrollment System using MySQL</li>
            <li><strong>Image and Video Processing Project</strong> (Mar 2025)<br>- Collected an image dataset of drone for sky object detection<br>- Developed object detection algorithms using MATLAB</li>
            <li><strong>Pre-Cooperative Education Project</strong> (Sep 2025)<br>- Built a mobile application Fitness Tracking using Flutter, Node.js, and MySQL<br>- Implemented features for Calendar, Google Map, Food Nutrition Tracking, and Weather Report</li>
            <li><strong>Web and Technology Project</strong> (Sep 2025)<br>- Developed a responsive novel reading website using HTML, CSS, Bootstrap, Node.js, and MySQL<br>- Designed and implemented database schema for storing novels, chapters, and user accounts</li>
        </ul>
    </div>

    <div id="catSpeech"></div>

    <div id="catChoice">
        <span>Wanna see something cool?</span>
        <button id="catYes">Yes</button>
        <button id="catNo">No</button>
    </div>

    <div id="telescopeChoice">
        <span>Wanna equip telescope?</span>
        <button id="telescopeYes">Yes</button>
        <button id="telescopeNo">No</button>
    </div>

    <div id="envPopup">üò∫ Environment ‡∏à‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô!</div>
    <div id="envPopupButtons">
        <button id="envYes">Yes</button>
        <button id="envNo">No</button>
    </div>

    <div class="toggleButtons">
        <button id="toggleSnow" class="toggleBtn"><span>‚ùÑÔ∏è</span> Snow</button>
        <button id="toggleLight" class="toggleBtn"><span>üí°</span> Light</button>
    </div>

    <div class="toggleButtons" style="left:auto; right:20px;">
        <button id="toggleMusic" class="toggleBtn"><span>üéµ</span> Music</button>
    </div>

    <audio id="bgMusic" loop>
        <source src="https://paulthebeatles.github.io/Port/Yuki&Hana.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/EXRLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/RGBELoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <script>
        // *** NEW: Second Loading Manager for runtime HDRI loading ***
        const hdriLoadingManager = new THREE.LoadingManager();
        const smallLoadingIndicator = document.getElementById('smallLoadingIndicator');

        hdriLoadingManager.onStart = function (url, itemsLoaded, itemsTotal) {
            smallLoadingIndicator.style.display = 'block';
        };

        hdriLoadingManager.onLoad = function () {
            smallLoadingIndicator.style.display = 'none';
        };
        // *** END: Second Loading Manager Setup ***


        // *** NEW: Loading Manager Setup for initial scene load ***
        const loadingManager = new THREE.LoadingManager();
        const loadingOverlay = document.getElementById('loadingOverlay');
        const progressBarInner = document.getElementById('progressBarInner');
        const loadingText = document.getElementById('loadingText');

        loadingManager.onProgress = function (url, itemsLoaded, itemsTotal) {
            const progress = (itemsLoaded / itemsTotal) * 100;
            progressBarInner.style.width = progress + '%';
            loadingText.textContent = `Loading... ${Math.floor(progress)}%`;
        };

        loadingManager.onLoad = function () {
            // Fade out the loading screen once everything is loaded
            loadingOverlay.style.opacity = 0;
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
            }, 1000); // 1 second for the fade-out transition

            // Prompt user to interact to start background music
            window.addEventListener('click', () => {
                if (!musicPlaying) {
                    bgMusic.play().catch(() => { });
                    musicPlaying = true;
                }
            }, { once: true });
        };

        // --- All Loaders now use the appropriate loadingManager ---
        const exrLoader = new THREE.EXRLoader(loadingManager);
        // RGBELoader uses the HDRI manager for cat's environment change
        const rgbeLoader = new THREE.RGBELoader(hdriLoadingManager); 
        const gltfLoader = new THREE.GLTFLoader(loadingManager);
        const audioLoader = new THREE.AudioLoader(loadingManager);
        // *** END: Initial Loading Manager Setup ***


        // === Renderer / Scene / Camera ===
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.5;
        document.body.appendChild(renderer.domElement);

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(100, 50, 50);

        const initialCamPos = camera.position.clone();
        const initialTarget = new THREE.Vector3(0, 5, 0);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.target.copy(initialTarget);

        // === Lights ===
        const ambientLight = new THREE.AmbientLight(0x808080, 0.2);
        scene.add(ambientLight);
        const sunLight = new THREE.DirectionalLight(0xffeedd, 0.5);
        sunLight.castShadow = true;
        sunLight.position.set(10, 20, 10);
        scene.add(sunLight);
        const nightAmbient = new THREE.AmbientLight(0x223344, 0.1);
        scene.add(nightAmbient);

        // === Environment ===
        const envGen = new THREE.PMREMGenerator(renderer);
        envGen.compileEquirectangularShader();
        // Initial environment load
        exrLoader.load("https://paulthebeatles.github.io/Port/modern_evening_street_1k.exr", tex => {
            const envTex = envGen.fromEquirectangular(tex).texture;
            scene.environment = envTex;
            scene.background = envTex;
            tex.dispose();
            envGen.dispose();
        });

        const VIEWS = {
            AboutMe: { pos: new THREE.Vector3(1, 1, 1), tar: new THREE.Vector3(0, 5, 10) },
            MyProject: { pos: new THREE.Vector3(0, 10, 20), tar: new THREE.Vector3(0, 0, 0) }
        };

        const clickable = [];
        let catObject = null;
        let creditRollObject = null;
        let envChanged = false;

        // === Load GLTF ===
        gltfLoader.load("https://paulthebeatles.github.io/Port/PortFinally.glb", gltf => {
            gltf.scene.traverse(obj => {
                if (obj.isMesh) obj.castShadow = obj.receiveShadow = true;
                if (["AboutMe", "Cat_Raycaster", "MyProject", "MyCer", "Telescope", "Credit"].includes(obj.name)) clickable.push(obj);
                if (obj.name === "Cat_Raycaster") catObject = obj;
                if (obj.name === "CreditRoll") creditRollObject = obj;
                if (obj.name === "MyName") {
                    const worldPos = new THREE.Vector3();
                    obj.getWorldPosition(worldPos);
                    VIEWS.AboutMe.tar.copy(worldPos);
                    VIEWS.AboutMe.pos.copy(worldPos).add(new THREE.Vector3(0, 0, 10));
                }
                if (obj.name === "Cer") {
                    const cerPos = new THREE.Vector3();
                    obj.getWorldPosition(cerPos);
                    VIEWS.MyCer = { tar: cerPos.clone(), pos: cerPos.clone().add(new THREE.Vector3(10, 10, 0)) };
                }
                if (obj.name === "CreditRoll") {
                    const creditPos = new THREE.Vector3();
                    obj.getWorldPosition(creditPos);
                    VIEWS.Credit = {
                        tar: creditPos.clone(),
                        pos: creditPos.clone().add(new THREE.Vector3(28, 48, 0))
                    };
                }
            });
            scene.add(gltf.scene);
        });

        const raycaster = new THREE.Raycaster();
        const pointer = new THREE.Vector2();

        // === Audio ===
        const listener = new THREE.AudioListener();
        camera.add(listener);
        const catSound = new THREE.PositionalAudio(listener);
        // Cat sound load
        audioLoader.load("https://paulthebeatles.github.io/Port/Meow.mp3", buffer => {
            catSound.setBuffer(buffer);
            catSound.setRefDistance(5);
            catSound.setVolume(5);
        });

        const bgMusic = document.getElementById('bgMusic');
        let musicPlaying = false;
        bgMusic.volume = 0.5;

        document.getElementById('toggleMusic').addEventListener('click', () => {
            if (bgMusic.paused) bgMusic.play();
            else bgMusic.pause();
        });

        // === Lerp ===
        let lerpActive = false, lerpAlpha = 0;
        const lerpStartPos = new THREE.Vector3();
        const lerpStartTar = new THREE.Vector3();
        const lerpEndPos = new THREE.Vector3();
        const lerpEndTar = new THREE.Vector3();

        // === Snow ===
        const snowCount = 800;
        const snowGeometry = new THREE.BufferGeometry();
        const snowPositions = [];
        for (let i = 0; i < snowCount; i++) {
            snowPositions.push((Math.random() - 0.5) * 200, Math.random() * 80 + 10, (Math.random() - 0.5) * 200);
        }
        snowGeometry.setAttribute('position', new THREE.Float32BufferAttribute(snowPositions, 3));
        const snowMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.8, transparent: true, opacity: 0.9 });
        const snowParticles = new THREE.Points(snowGeometry, snowMaterial);
        scene.add(snowParticles);

        let snowEnabled = true;
        document.getElementById("toggleSnow").addEventListener("click", () => { snowEnabled = !snowEnabled; snowParticles.visible = snowEnabled; });

        let lightOn = true;
        document.getElementById("toggleLight").addEventListener("click", () => { lightOn = !lightOn; });

        function updateSnow() {
            if (!snowEnabled) return;
            const positions = snowGeometry.attributes.position.array;
            for (let i = 1; i < positions.length; i += 3) {
                positions[i] -= 0.3 + Math.random() * 0.1;
                if (positions[i] < 0) positions[i] = 80;
            }
            snowGeometry.attributes.position.needsUpdate = true;
        }

        function updateLightTransition() {
            if (lightOn) {
                sunLight.intensity += (0.5 - sunLight.intensity) * 0.05;
                ambientLight.intensity += (0.2 - ambientLight.intensity) * 0.05;
                nightAmbient.intensity += (0 - nightAmbient.intensity) * 0.05;
                renderer.toneMappingExposure += (1.5 - renderer.toneMappingExposure) * 0.05;
                scene.fog = null;
            } else {
                sunLight.intensity += (0.05 - sunLight.intensity) * 0.05;
                ambientLight.intensity += (0.05 - ambientLight.intensity) * 0.05;
                nightAmbient.intensity += (0.15 - nightAmbient.intensity) * 0.05;
                renderer.toneMappingExposure += (0.8 - renderer.toneMappingExposure) * 0.05;
                if (!scene.fog) scene.fog = new THREE.FogExp2(0x000022, 0.005);
            }
        }

        // === Telescope Mode ===
        let telescopeMode = false;
        let telescopePivot = new THREE.Object3D();
        let isDragging = false;
        let previousMouse = { x: 0, y: 0 };

        window.addEventListener('mousedown', (e) => { if (telescopeMode) { isDragging = true; previousMouse.x = e.clientX; previousMouse.y = e.clientY; } });
        window.addEventListener('mouseup', () => { isDragging = false; });
        window.addEventListener('mousemove', (e) => {
            if (telescopeMode && isDragging) {
                const deltaX = (e.clientX - previousMouse.x) * 0.005;
                const deltaY = (e.clientY - previousMouse.y) * 0.005;
                telescopePivot.rotation.y -= deltaX;
                telescopePivot.rotation.x -= deltaY;
                telescopePivot.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, telescopePivot.rotation.x));
                previousMouse.x = e.clientX;
                previousMouse.y = e.clientY;
            }
        });

        function exitTelescopeMode() {
            if (!telescopeMode) return;
            scene.add(camera);
            telescopePivot.remove(camera);
            controls.enabled = true;
            telescopeMode = false;
        }

        // === Picking ===
        function onPick(event) {
            pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
            pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(pointer, camera);
            const intersects = raycaster.intersectObjects(clickable, true);
            if (intersects.length > 0) {
                let clicked = intersects[0].object;
                while (clicked.parent && !VIEWS[clicked.name] && clicked.name !== "Cat_Raycaster" && clicked.name !== "Telescope" && clicked.name !== "Credit") clicked = clicked.parent;

                if (clicked.name === "Cat_Raycaster") {
                    if (!clicked.children.includes(catSound)) clicked.add(catSound);
                    catSound.play();

                    const speech = document.getElementById("catSpeech");
                    const choice = document.getElementById("catChoice");

                    speech.textContent = "Meow!";
                    speech.style.display = "block";
                    speech.style.opacity = 1;

                    if (envChanged) {
                        // Environment ‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                        speech.textContent = "Meow! Find the telescope";
                        setTimeout(() => {
                            speech.style.opacity = 0;
                            setTimeout(() => { speech.style.display = "none"; }, 500);
                        }, 2000);
                        choice.style.display = "none"; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° Yes/No
                    } else {
                        // Environment ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏î)
                        setTimeout(() => {
                            speech.style.opacity = 0;
                            setTimeout(() => {
                                speech.style.display = "none";
                                choice.style.display = "block";
                            }, 500);
                        }, 2000);
                    }

                } else if (clicked.name === "MyProject") {
                    document.getElementById("projectPanel").style.display = "block";
                    if (catObject) {
                        const catPos = new THREE.Vector3();
                        catObject.getWorldPosition(catPos);
                        const catTarget = catPos.clone();
                        lerpStartPos.copy(camera.position);
                        lerpStartTar.copy(controls.target);
                        lerpEndPos.copy(catPos).add(new THREE.Vector3(10, 5, 5));
                        lerpEndTar.copy(catTarget);
                        lerpAlpha = 0;
                        lerpActive = true;
                    }
                } else if (clicked.name === "Telescope") {
                    document.getElementById("telescopeChoice").style.display = "block";
                } else if (clicked.name === "Credit") {
                    if (VIEWS.Credit) {
                        const view = VIEWS.Credit;
                        lerpStartPos.copy(camera.position);
                        lerpStartTar.copy(controls.target);
                        lerpEndPos.copy(view.pos);
                        lerpEndTar.copy(view.tar);
                        lerpAlpha = 0;
                        lerpActive = true;
                    }
                } else if (VIEWS[clicked.name]) {
                    const view = VIEWS[clicked.name];
                    lerpStartPos.copy(camera.position);
                    lerpStartTar.copy(controls.target);
                    lerpEndPos.copy(view.pos);
                    lerpEndTar.copy(view.tar);
                    lerpAlpha = 0;
                    lerpActive = true;
                }
            }
        }
        renderer.domElement.addEventListener('click', onPick);

        // === Close Panel / Home ===
        document.getElementById("closePanel").addEventListener("click", () => { document.getElementById("projectPanel").style.display = "none"; });

        document.getElementById("homeBtn").addEventListener("click", () => {
            lerpStartPos.copy(camera.position);
            lerpStartTar.copy(controls.target);
            lerpEndPos.copy(initialCamPos);
            lerpEndTar.copy(initialTarget);
            lerpAlpha = 0;
            lerpActive = true;
            document.getElementById("projectPanel").style.display = "none";
            exitTelescopeMode();
        });

        // === Cat Choice Yes/No ===

        document.getElementById("catYes").addEventListener("click", () => {
            document.getElementById("catChoice").style.display = "none";
            if (!envChanged) {
                const hdrUrl = "https://paulthebeatles.github.io/Port/HDR_blue_nebulae-1.hdr";
                const pmremGen = new THREE.PMREMGenerator(renderer);
                pmremGen.compileEquirectangularShader();

                // *** Use rgbeLoader with hdriLoadingManager (already done at the top) ***
                rgbeLoader.setDataType(THREE.UnsignedByteType).load(hdrUrl, tex => {
                    const envMap = pmremGen.fromEquirectangular(tex).texture;
                    scene.environment = envMap;
                    scene.background = envMap;
                    tex.dispose();
                    pmremGen.dispose();

                    envChanged = true;

                    const speech = document.getElementById("catSpeech");
                    speech.textContent = "Meow! Find the telescope";
                    speech.style.display = "block";
                    speech.style.opacity = 1;

                    setTimeout(() => {
                        speech.style.opacity = 0;
                        setTimeout(() => { speech.style.display = "none"; }, 500);
                    }, 7000);
                });
            }
        });

        document.getElementById("catNo").addEventListener("click", () => { document.getElementById("catChoice").style.display = "none"; });

        // === Telescope Choice Yes/No ===
        document.getElementById("telescopeYes").addEventListener("click", () => {
            document.getElementById("telescopeChoice").style.display = "none";
            const telescopeObj = clickable.find(obj => obj.name === "Telescope");
            if (telescopeObj) {
                const telescopePos = new THREE.Vector3();
                telescopeObj.getWorldPosition(telescopePos);

                lerpStartPos.copy(camera.position);
                lerpStartTar.copy(controls.target);
                lerpEndPos.set(telescopePos.x, telescopePos.y + 80, telescopePos.z);
                lerpEndTar.set(telescopePos.x, telescopePos.y + 100, telescopePos.z);
                lerpAlpha = 0;
                lerpActive = true;
            }
        });

        document.getElementById("telescopeNo").addEventListener("click", () => {
            document.getElementById("telescopeChoice").style.display = "none";
        });

        // === Animation Loop ===
        function loop() {
            if (lerpActive) {
                lerpAlpha += 0.02;
                if (lerpAlpha >= 1) { lerpAlpha = 1; lerpActive = false; }
                camera.position.lerpVectors(lerpStartPos, lerpEndPos, lerpAlpha);
                controls.target.lerpVectors(lerpStartTar, lerpEndTar, lerpAlpha);
            }
            updateSnow();
            updateLightTransition();
            controls.update();
            renderer.render(scene, camera);
            requestAnimationFrame(loop);
        }
        loop();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>
